<!DOCTYPE html>
<meta charset="utf-8">
<title>Pollution Visualization </title>

<script Type="text/javascript" src="../lib/d3.v3.min.js"></script>
<script src="../lib/d3.tip.v0.6.3.js"></script>
<script src="../lib/d3-queue.v3.min.js"></script>
<script src="../lib/topojson.v1.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<style type="text/css">
text {
	fill: #000;
	font: 18px sans-serif;
	font-weight: bold;
	pointer-events: none;
}
.state {
	fill: none;
	stroke: white;
	stroke-linejoin: round;
}
.legend text {
	fill: #000;
	font: 12px sans-serif;
	pointer-events: none;
}
.tooltip {
	position: absolute;           
    background:rgba(0,0,0,0.8);
    text-align: left;
    border:1px;
    border-radius:1px;
    font: 12px sans-serif;        
    width:auto;
    padding:4px;
    color:white;
    opacity:.6;
    pointer-events: none;       
}
.county {
	fill: none;
	stroke: #c0c0c0;
	stroke-width: .2;
	stroke-linejoin: round;
}
.label {
	font: 13px sans-serif;
	font-weight: bold;
}

</style>
<body> 

<input id="slider" type="range" min="0" max="196" value="0" step="1"/>
	<span id="range">2000-01-01</span>
	<button name="play" id="play">Play</button>
<div id="dropdown">    <label>Select Pollutant: </label>
</div>
<div id="title"></div>
<div id="choropleth"></div>
<script type="text/javascript">
/* -- TODO --
- decide on circles vs counties
- dynamic svg sizing
- make monthly csvs 
- change slider 	
- remove play button 
- edit legend scale    */

$(document).ready(function()	{
var alldates = []
d3.csv("dates_monthly.csv",function(csv){
            csv.map(function(d){
                alldates.push(d.date);
            })
            //console.log("alldates",alldates);
            //console.log("alldates",alldates[0]);
        });
		
var mleft = 40,
	w = 1100 - mleft,
    h = 700;

var pollutants = ['NO2', 'O3', 'SO2', 'CO'];
var years = ['2000', '2001', '2002', '2003', '2004', '2005', '2006', '2007', '2008', 
	'2009', '2010', '2011', '2012', '2013', '2014', '2015', '2016'];

var map = d3.map();
var map2 = d3.map();
var map3 = d3.map();
var map4 = d3.map();
var lat_lon = d3.map();

//var path = d3.geo.path();
var projection = d3.geo.albersUsa();//.translate([((w/2) - mleft), (h/2)]); 
//.scale(1100).translate([width / 2, height / 2]);
var path = d3.geo.path().projection(projection);

var current_date = "2000-01-01";
var end_date = "2016-06-01";
var current_feature = 0;
var current_window = 0;
var q = d3.queue();
var cname = d3.map();
var states = d3.map();
var files = ['no2_monthly.csv', 'o3_monthly.csv', 'so2_monthly.csv', 'co_monthly.csv'];
var maps = [map, map2, map3, map4];
	
var tip = d3.tip()
	.attr("class", "tooltip")
	.offset([-10, 0])
	.html(function(d) {
	var x = d.id;
	//d[alldates[count]] = map.get(d.id);
	var y = maps[current_feature].get(d.id);
	//(y ? console.log(y[0]): console.log("null"));
	var v = -1;
	(y ? (v = y[count]) : (v = null));
	d.name = cname.get(d.id);
	d.State = states.get(d.id);
	return "<strong>County: </strong>" + d.name + ", " + d.State + "<br/>" 
	+ pollutants[current_feature] + " AQI: " + v + "<br/>"
	+ "Date: " + current_date;
	})
		
var colorScale = d3.scale.threshold()
	.domain([10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,250])
	.range(['#98fb98','#a6fc8e','#b2fc85','#c0fd78','#c7fd71','#d4fd63','#dbfe5b','#e6fe4c','#f0fe38','#f6ff2d','#ffff00',
		'#ffed00','#ffd800','#ffc500','#ffb100','#ff9b00','#ff8400','#ff6a00','#ff4900','#ff0000']);
	//.range(['#98fb98','#b2fc85','#c7fd71','#dbfe5b','#f0fe38','#ffff00','#ffc800','#f98f00','#e25a00','#be2701','#8b0000']);
	
		
var svg = d3.select("#choropleth").append("svg")
    .attr("width", w + mleft)
    .attr("height", h)
	.attr("transform", "translate(" + mleft + "," + 0 + ")");

svg.call(tip);

var titlesvg = d3.select("#title").append("svg")
    .attr("width", w)
    .attr("height", 80)
	titlesvg.append("text")
		.attr("class", "title")
		.attr("x", (w/2) - 20)
		.attr("y", 30)
		.attr("text-anchor", "middle")
		.text("Pollution");

var count = 0;

q.defer(d3.json, 'us.json')
.defer(d3.csv, 'no2_monthly.csv', function(d) {
	map.set(+d.id, [+d['2000-01-01'],+d['2000-02-01'],+d['2000-03-01'],+d['2000-04-01'],+d['2000-05-01'],+d['2000-06-01'],+d['2000-07-01'],+d['2000-08-01'],+d['2000-09-01'],+d['2000-10-01'],+d['2000-11-01'],+d['2000-12-01'],+d['2001-01-01'],+d['2001-02-01'],+d['2001-03-01'],+d['2001-04-01'],+d['2001-05-01'],+d['2001-06-01'],+d['2001-07-01'],+d['2001-08-01'],+d['2001-09-01'],+d['2001-10-01'],+d['2001-11-01'],+d['2001-12-01'],+d['2002-01-01'],+d['2002-02-01'],+d['2002-03-01'],+d['2002-04-01'],+d['2002-05-01'],+d['2002-06-01'],+d['2002-07-01'],+d['2002-08-01'],+d['2002-09-01'],+d['2002-10-01'],+d['2002-11-01'],+d['2002-12-01'],+d['2003-01-01'],+d['2003-02-01'],+d['2003-03-01'],+d['2003-04-01'],+d['2003-05-01'],+d['2003-06-01'],+d['2003-07-01'],+d['2003-08-01'],+d['2003-09-01'],+d['2003-10-01'],+d['2003-11-01'],+d['2003-12-01'],+d['2004-01-01'],+d['2004-02-01'],+d['2004-03-01'],+d['2004-04-01'],+d['2004-05-01'],+d['2004-06-01'],+d['2004-07-01'],+d['2004-08-01'],+d['2004-09-01'],+d['2004-10-01'],+d['2004-11-01'],+d['2004-12-01'],+d['2005-01-01'],+d['2005-02-01'],+d['2005-03-01'],+d['2005-04-01'],+d['2005-05-01'],+d['2005-06-01'],+d['2005-07-01'],+d['2005-08-01'],+d['2005-09-01'],+d['2005-10-01'],+d['2005-11-01'],+d['2005-12-01'],+d['2006-01-01'],+d['2006-02-01'],+d['2006-03-01'],+d['2006-04-01'],+d['2006-05-01'],+d['2006-06-01'],+d['2006-07-01'],+d['2006-08-01'],+d['2006-09-01'],+d['2006-10-01'],+d['2006-11-01'],+d['2006-12-01'],+d['2007-01-01'],+d['2007-02-01'],+d['2007-03-01'],+d['2007-04-01'],+d['2007-05-01'],+d['2007-06-01'],+d['2007-07-01'],+d['2007-08-01'],+d['2007-09-01'],+d['2007-10-01'],+d['2007-11-01'],+d['2007-12-01'],+d['2008-01-01'],+d['2008-02-01'],+d['2008-03-01'],+d['2008-04-01'],+d['2008-05-01'],+d['2008-06-01'],+d['2008-07-01'],+d['2008-08-01'],+d['2008-09-01'],+d['2008-10-01'],+d['2008-11-01'],+d['2008-12-01'],+d['2009-01-01'],+d['2009-02-01'],+d['2009-03-01'],+d['2009-04-01'],+d['2009-05-01'],+d['2009-06-01'],+d['2009-07-01'],+d['2009-08-01'],+d['2009-09-01'],+d['2009-10-01'],+d['2009-11-01'],+d['2009-12-01'],+d['2010-01-01'],+d['2010-02-01'],+d['2010-03-01'],+d['2010-04-01'],+d['2010-05-01'],+d['2010-06-01'],+d['2010-07-01'],+d['2010-08-01'],+d['2010-09-01'],+d['2010-10-01'],+d['2010-11-01'],+d['2010-12-01'],+d['2011-01-01'],+d['2011-02-01'],+d['2011-03-01'],+d['2011-04-01'],+d['2011-05-01'],+d['2011-06-01'],+d['2011-07-01'],+d['2011-08-01'],+d['2011-09-01'],+d['2011-10-01'],+d['2011-11-01'],+d['2011-12-01'],+d['2012-01-01'],+d['2012-02-01'],+d['2012-03-01'],+d['2012-04-01'],+d['2012-05-01'],+d['2012-06-01'],+d['2012-07-01'],+d['2012-08-01'],+d['2012-09-01'],+d['2012-10-01'],+d['2012-11-01'],+d['2012-12-01'],+d['2013-01-01'],+d['2013-02-01'],+d['2013-03-01'],+d['2013-04-01'],+d['2013-05-01'],+d['2013-06-01'],+d['2013-07-01'],+d['2013-08-01'],+d['2013-09-01'],+d['2013-10-01'],+d['2013-11-01'],+d['2013-12-01'],+d['2014-01-01'],+d['2014-02-01'],+d['2014-03-01'],+d['2014-04-01'],+d['2014-05-01'],+d['2014-06-01'],+d['2014-07-01'],+d['2014-08-01'],+d['2014-09-01'],+d['2014-10-01'],+d['2014-11-01'],+d['2014-12-01'],+d['2015-01-01'],+d['2015-02-01'],+d['2015-03-01'],+d['2015-04-01'],+d['2015-05-01'],+d['2015-06-01'],+d['2015-07-01'],+d['2015-08-01'],+d['2015-09-01'],+d['2015-10-01'],+d['2015-11-01'],+d['2015-12-01'],+d['2016-01-01'],+d['2016-02-01'],+d['2016-03-01'],+d['2016-04-01'],+d['2016-05-01']]
);})
.defer(d3.csv, 'o3_monthly.csv', function(d) {
	map2.set(+d.id, [+d['2000-01-01'],+d['2000-02-01'],+d['2000-03-01'],+d['2000-04-01'],+d['2000-05-01'],+d['2000-06-01'],+d['2000-07-01'],+d['2000-08-01'],+d['2000-09-01'],+d['2000-10-01'],+d['2000-11-01'],+d['2000-12-01'],+d['2001-01-01'],+d['2001-02-01'],+d['2001-03-01'],+d['2001-04-01'],+d['2001-05-01'],+d['2001-06-01'],+d['2001-07-01'],+d['2001-08-01'],+d['2001-09-01'],+d['2001-10-01'],+d['2001-11-01'],+d['2001-12-01'],+d['2002-01-01'],+d['2002-02-01'],+d['2002-03-01'],+d['2002-04-01'],+d['2002-05-01'],+d['2002-06-01'],+d['2002-07-01'],+d['2002-08-01'],+d['2002-09-01'],+d['2002-10-01'],+d['2002-11-01'],+d['2002-12-01'],+d['2003-01-01'],+d['2003-02-01'],+d['2003-03-01'],+d['2003-04-01'],+d['2003-05-01'],+d['2003-06-01'],+d['2003-07-01'],+d['2003-08-01'],+d['2003-09-01'],+d['2003-10-01'],+d['2003-11-01'],+d['2003-12-01'],+d['2004-01-01'],+d['2004-02-01'],+d['2004-03-01'],+d['2004-04-01'],+d['2004-05-01'],+d['2004-06-01'],+d['2004-07-01'],+d['2004-08-01'],+d['2004-09-01'],+d['2004-10-01'],+d['2004-11-01'],+d['2004-12-01'],+d['2005-01-01'],+d['2005-02-01'],+d['2005-03-01'],+d['2005-04-01'],+d['2005-05-01'],+d['2005-06-01'],+d['2005-07-01'],+d['2005-08-01'],+d['2005-09-01'],+d['2005-10-01'],+d['2005-11-01'],+d['2005-12-01'],+d['2006-01-01'],+d['2006-02-01'],+d['2006-03-01'],+d['2006-04-01'],+d['2006-05-01'],+d['2006-06-01'],+d['2006-07-01'],+d['2006-08-01'],+d['2006-09-01'],+d['2006-10-01'],+d['2006-11-01'],+d['2006-12-01'],+d['2007-01-01'],+d['2007-02-01'],+d['2007-03-01'],+d['2007-04-01'],+d['2007-05-01'],+d['2007-06-01'],+d['2007-07-01'],+d['2007-08-01'],+d['2007-09-01'],+d['2007-10-01'],+d['2007-11-01'],+d['2007-12-01'],+d['2008-01-01'],+d['2008-02-01'],+d['2008-03-01'],+d['2008-04-01'],+d['2008-05-01'],+d['2008-06-01'],+d['2008-07-01'],+d['2008-08-01'],+d['2008-09-01'],+d['2008-10-01'],+d['2008-11-01'],+d['2008-12-01'],+d['2009-01-01'],+d['2009-02-01'],+d['2009-03-01'],+d['2009-04-01'],+d['2009-05-01'],+d['2009-06-01'],+d['2009-07-01'],+d['2009-08-01'],+d['2009-09-01'],+d['2009-10-01'],+d['2009-11-01'],+d['2009-12-01'],+d['2010-01-01'],+d['2010-02-01'],+d['2010-03-01'],+d['2010-04-01'],+d['2010-05-01'],+d['2010-06-01'],+d['2010-07-01'],+d['2010-08-01'],+d['2010-09-01'],+d['2010-10-01'],+d['2010-11-01'],+d['2010-12-01'],+d['2011-01-01'],+d['2011-02-01'],+d['2011-03-01'],+d['2011-04-01'],+d['2011-05-01'],+d['2011-06-01'],+d['2011-07-01'],+d['2011-08-01'],+d['2011-09-01'],+d['2011-10-01'],+d['2011-11-01'],+d['2011-12-01'],+d['2012-01-01'],+d['2012-02-01'],+d['2012-03-01'],+d['2012-04-01'],+d['2012-05-01'],+d['2012-06-01'],+d['2012-07-01'],+d['2012-08-01'],+d['2012-09-01'],+d['2012-10-01'],+d['2012-11-01'],+d['2012-12-01'],+d['2013-01-01'],+d['2013-02-01'],+d['2013-03-01'],+d['2013-04-01'],+d['2013-05-01'],+d['2013-06-01'],+d['2013-07-01'],+d['2013-08-01'],+d['2013-09-01'],+d['2013-10-01'],+d['2013-11-01'],+d['2013-12-01'],+d['2014-01-01'],+d['2014-02-01'],+d['2014-03-01'],+d['2014-04-01'],+d['2014-05-01'],+d['2014-06-01'],+d['2014-07-01'],+d['2014-08-01'],+d['2014-09-01'],+d['2014-10-01'],+d['2014-11-01'],+d['2014-12-01'],+d['2015-01-01'],+d['2015-02-01'],+d['2015-03-01'],+d['2015-04-01'],+d['2015-05-01'],+d['2015-06-01'],+d['2015-07-01'],+d['2015-08-01'],+d['2015-09-01'],+d['2015-10-01'],+d['2015-11-01'],+d['2015-12-01'],+d['2016-01-01'],+d['2016-02-01'],+d['2016-03-01'],+d['2016-04-01'],+d['2016-05-01']]
);})
.defer(d3.csv, 'so2_monthly.csv', function(d) {
	map3.set(+d.id, [+d['2000-01-01'],+d['2000-02-01'],+d['2000-03-01'],+d['2000-04-01'],+d['2000-05-01'],+d['2000-06-01'],+d['2000-07-01'],+d['2000-08-01'],+d['2000-09-01'],+d['2000-10-01'],+d['2000-11-01'],+d['2000-12-01'],+d['2001-01-01'],+d['2001-02-01'],+d['2001-03-01'],+d['2001-04-01'],+d['2001-05-01'],+d['2001-06-01'],+d['2001-07-01'],+d['2001-08-01'],+d['2001-09-01'],+d['2001-10-01'],+d['2001-11-01'],+d['2001-12-01'],+d['2002-01-01'],+d['2002-02-01'],+d['2002-03-01'],+d['2002-04-01'],+d['2002-05-01'],+d['2002-06-01'],+d['2002-07-01'],+d['2002-08-01'],+d['2002-09-01'],+d['2002-10-01'],+d['2002-11-01'],+d['2002-12-01'],+d['2003-01-01'],+d['2003-02-01'],+d['2003-03-01'],+d['2003-04-01'],+d['2003-05-01'],+d['2003-06-01'],+d['2003-07-01'],+d['2003-08-01'],+d['2003-09-01'],+d['2003-10-01'],+d['2003-11-01'],+d['2003-12-01'],+d['2004-01-01'],+d['2004-02-01'],+d['2004-03-01'],+d['2004-04-01'],+d['2004-05-01'],+d['2004-06-01'],+d['2004-07-01'],+d['2004-08-01'],+d['2004-09-01'],+d['2004-10-01'],+d['2004-11-01'],+d['2004-12-01'],+d['2005-01-01'],+d['2005-02-01'],+d['2005-03-01'],+d['2005-04-01'],+d['2005-05-01'],+d['2005-06-01'],+d['2005-07-01'],+d['2005-08-01'],+d['2005-09-01'],+d['2005-10-01'],+d['2005-11-01'],+d['2005-12-01'],+d['2006-01-01'],+d['2006-02-01'],+d['2006-03-01'],+d['2006-04-01'],+d['2006-05-01'],+d['2006-06-01'],+d['2006-07-01'],+d['2006-08-01'],+d['2006-09-01'],+d['2006-10-01'],+d['2006-11-01'],+d['2006-12-01'],+d['2007-01-01'],+d['2007-02-01'],+d['2007-03-01'],+d['2007-04-01'],+d['2007-05-01'],+d['2007-06-01'],+d['2007-07-01'],+d['2007-08-01'],+d['2007-09-01'],+d['2007-10-01'],+d['2007-11-01'],+d['2007-12-01'],+d['2008-01-01'],+d['2008-02-01'],+d['2008-03-01'],+d['2008-04-01'],+d['2008-05-01'],+d['2008-06-01'],+d['2008-07-01'],+d['2008-08-01'],+d['2008-09-01'],+d['2008-10-01'],+d['2008-11-01'],+d['2008-12-01'],+d['2009-01-01'],+d['2009-02-01'],+d['2009-03-01'],+d['2009-04-01'],+d['2009-05-01'],+d['2009-06-01'],+d['2009-07-01'],+d['2009-08-01'],+d['2009-09-01'],+d['2009-10-01'],+d['2009-11-01'],+d['2009-12-01'],+d['2010-01-01'],+d['2010-02-01'],+d['2010-03-01'],+d['2010-04-01'],+d['2010-05-01'],+d['2010-06-01'],+d['2010-07-01'],+d['2010-08-01'],+d['2010-09-01'],+d['2010-10-01'],+d['2010-11-01'],+d['2010-12-01'],+d['2011-01-01'],+d['2011-02-01'],+d['2011-03-01'],+d['2011-04-01'],+d['2011-05-01'],+d['2011-06-01'],+d['2011-07-01'],+d['2011-08-01'],+d['2011-09-01'],+d['2011-10-01'],+d['2011-11-01'],+d['2011-12-01'],+d['2012-01-01'],+d['2012-02-01'],+d['2012-03-01'],+d['2012-04-01'],+d['2012-05-01'],+d['2012-06-01'],+d['2012-07-01'],+d['2012-08-01'],+d['2012-09-01'],+d['2012-10-01'],+d['2012-11-01'],+d['2012-12-01'],+d['2013-01-01'],+d['2013-02-01'],+d['2013-03-01'],+d['2013-04-01'],+d['2013-05-01'],+d['2013-06-01'],+d['2013-07-01'],+d['2013-08-01'],+d['2013-09-01'],+d['2013-10-01'],+d['2013-11-01'],+d['2013-12-01'],+d['2014-01-01'],+d['2014-02-01'],+d['2014-03-01'],+d['2014-04-01'],+d['2014-05-01'],+d['2014-06-01'],+d['2014-07-01'],+d['2014-08-01'],+d['2014-09-01'],+d['2014-10-01'],+d['2014-11-01'],+d['2014-12-01'],+d['2015-01-01'],+d['2015-02-01'],+d['2015-03-01'],+d['2015-04-01'],+d['2015-05-01'],+d['2015-06-01'],+d['2015-07-01'],+d['2015-08-01'],+d['2015-09-01'],+d['2015-10-01'],+d['2015-11-01'],+d['2015-12-01'],+d['2016-01-01'],+d['2016-02-01'],+d['2016-03-01'],+d['2016-04-01'],+d['2016-05-01']]
);})
.defer(d3.csv, 'co_monthly.csv', function(d) {
	map4.set(+d.id, [+d['2000-01-01'],+d['2000-02-01'],+d['2000-03-01'],+d['2000-04-01'],+d['2000-05-01'],+d['2000-06-01'],+d['2000-07-01'],+d['2000-08-01'],+d['2000-09-01'],+d['2000-10-01'],+d['2000-11-01'],+d['2000-12-01'],+d['2001-01-01'],+d['2001-02-01'],+d['2001-03-01'],+d['2001-04-01'],+d['2001-05-01'],+d['2001-06-01'],+d['2001-07-01'],+d['2001-08-01'],+d['2001-09-01'],+d['2001-10-01'],+d['2001-11-01'],+d['2001-12-01'],+d['2002-01-01'],+d['2002-02-01'],+d['2002-03-01'],+d['2002-04-01'],+d['2002-05-01'],+d['2002-06-01'],+d['2002-07-01'],+d['2002-08-01'],+d['2002-09-01'],+d['2002-10-01'],+d['2002-11-01'],+d['2002-12-01'],+d['2003-01-01'],+d['2003-02-01'],+d['2003-03-01'],+d['2003-04-01'],+d['2003-05-01'],+d['2003-06-01'],+d['2003-07-01'],+d['2003-08-01'],+d['2003-09-01'],+d['2003-10-01'],+d['2003-11-01'],+d['2003-12-01'],+d['2004-01-01'],+d['2004-02-01'],+d['2004-03-01'],+d['2004-04-01'],+d['2004-05-01'],+d['2004-06-01'],+d['2004-07-01'],+d['2004-08-01'],+d['2004-09-01'],+d['2004-10-01'],+d['2004-11-01'],+d['2004-12-01'],+d['2005-01-01'],+d['2005-02-01'],+d['2005-03-01'],+d['2005-04-01'],+d['2005-05-01'],+d['2005-06-01'],+d['2005-07-01'],+d['2005-08-01'],+d['2005-09-01'],+d['2005-10-01'],+d['2005-11-01'],+d['2005-12-01'],+d['2006-01-01'],+d['2006-02-01'],+d['2006-03-01'],+d['2006-04-01'],+d['2006-05-01'],+d['2006-06-01'],+d['2006-07-01'],+d['2006-08-01'],+d['2006-09-01'],+d['2006-10-01'],+d['2006-11-01'],+d['2006-12-01'],+d['2007-01-01'],+d['2007-02-01'],+d['2007-03-01'],+d['2007-04-01'],+d['2007-05-01'],+d['2007-06-01'],+d['2007-07-01'],+d['2007-08-01'],+d['2007-09-01'],+d['2007-10-01'],+d['2007-11-01'],+d['2007-12-01'],+d['2008-01-01'],+d['2008-02-01'],+d['2008-03-01'],+d['2008-04-01'],+d['2008-05-01'],+d['2008-06-01'],+d['2008-07-01'],+d['2008-08-01'],+d['2008-09-01'],+d['2008-10-01'],+d['2008-11-01'],+d['2008-12-01'],+d['2009-01-01'],+d['2009-02-01'],+d['2009-03-01'],+d['2009-04-01'],+d['2009-05-01'],+d['2009-06-01'],+d['2009-07-01'],+d['2009-08-01'],+d['2009-09-01'],+d['2009-10-01'],+d['2009-11-01'],+d['2009-12-01'],+d['2010-01-01'],+d['2010-02-01'],+d['2010-03-01'],+d['2010-04-01'],+d['2010-05-01'],+d['2010-06-01'],+d['2010-07-01'],+d['2010-08-01'],+d['2010-09-01'],+d['2010-10-01'],+d['2010-11-01'],+d['2010-12-01'],+d['2011-01-01'],+d['2011-02-01'],+d['2011-03-01'],+d['2011-04-01'],+d['2011-05-01'],+d['2011-06-01'],+d['2011-07-01'],+d['2011-08-01'],+d['2011-09-01'],+d['2011-10-01'],+d['2011-11-01'],+d['2011-12-01'],+d['2012-01-01'],+d['2012-02-01'],+d['2012-03-01'],+d['2012-04-01'],+d['2012-05-01'],+d['2012-06-01'],+d['2012-07-01'],+d['2012-08-01'],+d['2012-09-01'],+d['2012-10-01'],+d['2012-11-01'],+d['2012-12-01'],+d['2013-01-01'],+d['2013-02-01'],+d['2013-03-01'],+d['2013-04-01'],+d['2013-05-01'],+d['2013-06-01'],+d['2013-07-01'],+d['2013-08-01'],+d['2013-09-01'],+d['2013-10-01'],+d['2013-11-01'],+d['2013-12-01'],+d['2014-01-01'],+d['2014-02-01'],+d['2014-03-01'],+d['2014-04-01'],+d['2014-05-01'],+d['2014-06-01'],+d['2014-07-01'],+d['2014-08-01'],+d['2014-09-01'],+d['2014-10-01'],+d['2014-11-01'],+d['2014-12-01'],+d['2015-01-01'],+d['2015-02-01'],+d['2015-03-01'],+d['2015-04-01'],+d['2015-05-01'],+d['2015-06-01'],+d['2015-07-01'],+d['2015-08-01'],+d['2015-09-01'],+d['2015-10-01'],+d['2015-11-01'],+d['2015-12-01'],+d['2016-01-01'],+d['2016-02-01'],+d['2016-03-01'],+d['2016-04-01'],+d['2016-05-01']]
);})
.defer(d3.csv, "id_state_countyname.csv", function(d) {
	cname.set(+d.id, d.name);})
.defer(d3.csv, "id_state_countyname.csv", function(d) {
	states.set(+d.id, d.State);})
.defer(d3.csv, "lat_long_filtered.csv", function(d) {
	lat_lon.set(+d.id, [+d.lat,+d.lon]);})
.await(create_map);

//var us2;
	
function create_map(error, us, pollution) {
	if (error) throw error;
	//console.log(current_date);
	//console.log(alldates[count]);

	//console.log(map.get(4013)[0]);
	svg.append("g")
		.attr("class", "county")
		.selectAll("path")
		.data(topojson.feature(us, us.objects.counties).features)
		.enter().append("path")
		.attr("d", path);
	
	svg.append("path")
		.datum(topojson.mesh(us, us.objects.states, 
			function(x, y) { 
				return (x.id !== y.id); }
			))
		.attr("class", "state")
		.attr("d", path);
		
	svg.append("g")
        .attr("class", "county")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.counties).features)
        .enter().append("path")
        .attr("fill", function(d) {
			//console.log(d.id);
			var x = d.id
			var y = maps[current_feature].get(d.id);
			//(y ? console.log(y[0]): console.log("null"));
			var val = -1;
			(y ? (val = y[count]) : (val = -1));
			return (val > 0 ? colorScale(val) : '#ededed');})
		.attr("d", path)
		.on("mouseover", mouseover)
		.on("mouseout", mouseout);
	
	svg.append("text")
		.attr("class", "label")
		.attr("transform", "translate(" + (930) + "," + (-8) + ")")
		.attr("dy", "1.5em")
		.style("text-anchor", "end")
		.text("AQI");
	
	    d3.csv("no2_ll.csv", function(data) {
        for (var i in data) {
            var projected = projection([parseFloat(data[i].lon), parseFloat(data[i].lat)]);
            var cid = data[i].id;
			svg.append("g")
			.append("circle").datum(data[i])
			.attr("cx", projected[0])
			.attr("cy", projected[1])
			.attr("r", function(d) {
				var x = cid
				var y = maps[current_feature].get(cid);
				//(y ? console.log(y[0]): console.log("null"));
				var val = -1;
				(y ? (val = y[count]) : (val = -1));
				return (val > 0 ? 10 : 0);})
			.attr("fill", function(d) {
				var x = cid
				var y = maps[current_feature].get(cid);
				//(y ? console.log(y[0]): console.log("null"));
				var val = -1;
				(y ? (val = y[count]) : (val = -1));
				return (val > 0 ? colorScale(val) : null);})
			.attr("opacity", function (d) {
				var x = cid
				var y = maps[current_feature].get(cid);
				//(y ? console.log(y[0]): console.log("null"));
				var val = -1;
				(y ? (val = y[count]) : (val = -1));
				return (val > 0 ? .4 : 0);})
			.on("mouseover", function(d) {
				tip.show(d);
				d3.selectAll(".tooltip").style("opacity", .8);})
			.on("mouseout", function(d) {
				tip.hide(d);});
        }
    })
			
}



var running = false;
var timer;
		
$("button").on("click", function() {
//change duration to adjust speed of animation
	var duration = 1.5,
	maxstep = 196,
	minstep = 0;
	
	if (running == true) {		
		$("button").html("Play");
		running = false;
		clearInterval(timer);
	} 
	else if (running == false) {		
		$("button").html("Pause");
				
		sliderValue = $("#slider").val();
				
		timer = setInterval( function(){
			if (sliderValue < maxstep){
				sliderValue++;
				$("#slider").val(sliderValue);
				$('#range').html(alldates[sliderValue]);
			}
			$("#slider").val(sliderValue);
			//console.log(sliderValue);
			count = sliderValue;
			current_date = alldates[count];
			update_map();			
		}, duration);
		running = true;		
			}
		});
	
$("#slider").on("change", function(){
	sliderValue = $("#slider").val();
	console.log(sliderValue);
	count = sliderValue
	current_date = alldates[count];
	update_map();
	$("#range").html(alldates[$("#slider").val()]);
	clearInterval(timer);
	$("button").html("Play");
});
		
update_map = function(d) {
	d3.selectAll("path")
		.attr("fill", function(d) {
			//console.log(d.id);
			var x = d.id
			var y = maps[current_feature].get(d.id);
			//(y ? console.log(y[0]): console.log("null"));
			var val = -1;
			(y ? (val = y[count]) : (val = -1));
			return (val > 0 ? colorScale(val) : '#ededed');})
		.attr("d", path);
		
	d3.selectAll("circle").remove();

	d3.csv("no2_ll.csv", function(data) {
        for (var i in data) {
            var projected = projection([parseFloat(data[i].lon), parseFloat(data[i].lat)]);
            var cid = data[i].id;
			svg.append("g")
			.append("circle").datum(data[i])
			.attr("cx", projected[0])
			.attr("cy", projected[1])
			.attr("r", function(d) {
				var x = cid
				var y = maps[current_feature].get(cid);
				//(y ? console.log(y[0]): console.log("null"));
				var val = -1;
				(y ? (val = y[count]) : (val = -1));
				return (val > 0 ? 10 : 0);})
			.attr("fill", function(d) {
				var x = cid
				var y = maps[current_feature].get(cid);
				//(y ? console.log(y[0]): console.log("null"));
				var val = -1;
				(y ? (val = y[count]) : (val = -1));
				return (val > 0 ? colorScale(val) : null);})
			.attr("opacity", function (d) {
				var x = cid
				var y = maps[current_feature].get(cid);
				//(y ? console.log(y[0]): console.log("null"));
				var val = -1;
				(y ? (val = y[count]) : (val = -1));
				return (val > 0 ? .4 : 0);})
			.on("mouseover", function(d) {
				tip.show(d);
				d3.selectAll(".tooltip").style("opacity", .8);})
			.on("mouseout", function(d) {
				tip.hide(d);});
        }
    })
}
		
var selectpol = d3.select("#dropdown")
	.append("select")
	.attr("class", "select")
	.on("change", changepol)
	.attr("id", "selectpol")
	.selectAll("option")
    .data(pollutants)
    .enter()
    .append("option")
    .attr("value", function(d, i) { return i; })
    .text(function(d) { return d; })
	
/*var selectyr = d3.select("#dropdown2")
	.append("select")
	.attr("class", "select")
	.on("change", changeyr)
	.attr("id", "selectyr")
	.selectAll("option")
    .data(years)
    .enter()
    .append("option")
    .attr("value", function(d, i) { return i; })
    .text(function(d) { return d; })*/
	
var legendDomain =
		colorScale.range().map(function(d) {
		var r = (colorScale.invertExtent(d));
		return r[0]; });
	
legendDomain[0]=0;

var colors = ['#98fb98','#b2fc85','#c7fd71','#dbfe5b','#f0fe38','#ffff00','#ffc800','#f98f00','#e25a00','#be2701','#8b0000'];

var legend = svg.selectAll(".legend")
		.data(legendDomain)
		.enter().append("g")
        .attr("class", "legend")
		.attr("transform", "translate(" + 890 + "," + 18 + ")");

    legend.append("rect")
        .attr("x", 0)
        .attr("y", function(d, i) { return 23 * i; }) 
        .attr("width", 30)
        .attr("height", 23)
        .style("fill", function(d) { return colorScale(d); });

	legend.append("text")
		.text(function(d, i) { return ((legendDomain[i])); })
        .attr("x", 25)
        .attr("y", function(d, i) { return ((23 * i) + 10); })
		.style("text-anchor", "start")
		.attr("dx", "1em")
		.attr("dy", ".2em");	

function mouseover(d) {
	tip.show(d);
	d3.selectAll(".tooltip").style("opacity", .8);
	d3.select(this).style("opacity", .3);
}

function mouseout(d) {
	tip.hide(d);
	d3.select(this).style("opacity", 1);	
}
			
function changepol() {     
	var pol = d3.select("#dropdown")
       .select("select")
       .property("value");
    current_feature = +pol;
    update_map();
    }; 

/*function changeyr() {     
	var yr = d3.select("#dropdown2")
       .select("select")
       .property("value");
    current_window = +yr;
	current_date = yrrange[current_window][0];
	end_date = yrrange[current_window][1];
    create_map("", us2);
    }; */
});
</script>
</body>
</html>